<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni Logic Professional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap');
        body { font-family: 'Pyidaungsu', sans-serif; background-color: #000814; color: white; }
        .box-p { border: 4px solid #ff4136; color: #ff4136; border-radius: 50%; width: 65px; height: 65px; font-size: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; background: white; font-weight: 900; }
        .box-e { border: 4px solid #b10dc9; color: #b10dc9; border-radius: 12px; width: 65px; height: 65px; font-size: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; background: white; font-weight: 900; position: relative; }
        .box-s { border: 4px solid #2ecc40; color: #2ecc40; border-radius: 8px; width: 60px; height: 60px; font-size: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; transform: rotate(45deg); background: white; font-weight: 900; position: relative; }
        .box-s span { transform: rotate(-45deg); }
        .locked-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); border-radius: inherit; display: flex; align-items: center; justify-content: center; color: white; font-size: 10px; font-weight: 900; border: 1px solid rgba(255,255,255,0.2); }
        .roll-card { flex-shrink: 0; width: 280px; background: rgba(0, 51, 102, 0.4); border-radius: 20px; padding: 12px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); }
        .g-num { background: #ffdc00; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 2px solid #000; color: black; font-weight: 900; }
        .mini-shape { width: 26px; height: 26px; display: inline-flex; align-items: center; justify-content: center; background: white; font-weight: 900; font-size: 12px; border-width: 2px; }
    </style>
</head>
<body class="p-2 pb-10">

    <div id="lock-screen" class="fixed inset-0 bg-[#000814] z-[9999] flex flex-col items-center justify-center p-6 text-center" style="display: none;">
        <h1 class="text-4xl font-black mb-10 text-cyan-400 italic">OMNI LOGIC</h1>
        <div class="bg-red-600/10 border border-red-500/50 p-6 rounded-3xl mb-8 w-full max-w-sm">
            <p id="lock-msg" class="text-red-500 font-black uppercase italic">Trial Expired!</p>
        </div>
        <input type="text" id="lock-license-input" class="w-full max-w-sm p-4 rounded-xl text-black text-center font-black border-4 border-cyan-500 mb-4" placeholder="LICENSE CODE">
        <button onclick="activateCode()" class="w-full max-w-sm bg-cyan-500 py-4 rounded-xl font-black shadow-lg">Activate Premium</button>
        <a href="YOUR_TELEGRAM_LINK" class="mt-6 text-cyan-400 font-bold underline">Buy via Telegram</a>
        <p class="text-gray-600 text-[10px] mt-10" id="device-id-display"></p>
    </div>

    <div id="app-main" style="display: none;">
        <div class="max-w-md mx-auto space-y-4">
            <div class="text-center pt-4">
                <h1 class="text-3xl font-black italic text-cyan-500">OMNI LOGIC</h1>
                <div id="plan-status" class="mt-2 text-[10px] text-cyan-400 uppercase tracking-widest font-bold">Syncing...</div>
            </div>

            <div class="bg-[#001d3d] p-4 grid grid-cols-3 gap-1 text-center rounded-[30px] border-b-4 border-cyan-500 shadow-2xl">
                <div>
                    <p class="text-[10px] font-bold text-gray-500 mb-1 uppercase">P-Logic (Free)</p>
                    <div class="box-p"><span id="pred-p">-</span></div>
                </div>
                <div>
                    <p class="text-[10px] font-bold text-gray-500 mb-1 uppercase">E-Logic</p>
                    <div class="box-e">
                        <span id="pred-e" class="blur-sm">-</span>
                        <div id="lock-e" class="locked-overlay">PREMIUM</div>
                    </div>
                </div>
                <div>
                    <p class="text-[10px] font-bold text-gray-500 mb-1 uppercase">S-Logic</p>
                    <div class="box-s">
                        <span id="pred-s" class="blur-sm"></span>
                        <div id="lock-s" class="locked-overlay"><span>PREMIUM</span></div>
                    </div>
                </div>
            </div>

            <div class="bg-[#001d3d] p-5 rounded-[2.5rem] flex items-center justify-between border border-white/5 shadow-inner">
                <div class="text-center flex-1"><div id="highlight-g" class="text-6xl font-black text-cyan-400">-</div></div>
                <div class="flex flex-col gap-2 w-32">
                    <input type="number" id="digit-input" class="w-full rounded-xl text-center text-4xl font-black p-2 border-4 border-cyan-500 text-black" placeholder="?" oninput="validate(this)" disabled>
                    <button id="btn-submit" class="w-full py-4 bg-cyan-500 text-white font-black rounded-xl text-xl disabled:opacity-30" onclick="submit()" disabled>ENTER</button>
                </div>
            </div>

            <div id="history-container" class="flex overflow-x-auto gap-3 pb-2"></div>

            <div id="premium-btn-box">
                <button onclick="showUpgrade()" class="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-black py-4 rounded-2xl font-black uppercase shadow-xl italic">üöÄ Unlock All Logics (S & E)</button>
            </div>

            <button onclick="fullReset()" class="w-full bg-slate-800 py-3 text-red-400 font-bold rounded-xl text-xs uppercase border border-white/10">Full Clear Logs</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://folxuczagcspjnypyopw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvbHh1Y3phZ2NzcGpueXB5b3B3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjQ4MTAsImV4cCI6MjA4MTkwMDgxMH0.gOwmroH4rGr1iGATXK1NoSfg7gNs87hXJ8E3w13s5xo';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let deviceId = ""; let isPremium = false; let remMins = 0; let syncBuffer = 0;
        let history = []; let roll = 1, stage = 1; let pNext, eNext, sNext; let timerStarted = false;

        async function initDevice() {
            // Hardware-based Identification (Canvas Fingerprinting ·Ä°·Äï·Ä´·Ä°·Äù·ÄÑ·Ä∫)
            const canvas = document.createElement('canvas');
            const gl = canvas.getContext('webgl');
            const renderer = gl ? gl.getParameter(gl.RENDERER) : "";
            const info = [navigator.userAgent, screen.height, screen.width, renderer].join('|');
            const encoder = new TextEncoder();
            const data = encoder.encode(info);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            deviceId = "OMNI-" + hashArray.map(b => b.toString(16).padStart(2, '0')).join('').substring(0, 8).toUpperCase();
            
            document.getElementById('device-id-display').innerText = "DEVICE ID: " + deviceId;
            checkAccess();
        }

        async function checkAccess() {
            try {
                const { data } = await supabaseClient.rpc('check_access_v2', { input_device_id: deviceId });
                if (data && data.can_access) {
                    isPremium = data.is_premium;
                    remMins = isPremium ? data.mins : Math.min(data.mins || 90, 90);
                    document.getElementById('lock-screen').style.display = 'none';
                    document.getElementById('app-main').style.display = 'block';
                    document.getElementById('digit-input').disabled = false;
                    updateUI();
                } else {
                    document.getElementById('lock-screen').style.display = 'flex';
                    document.getElementById('lock-msg').innerText = data.reason || "Trial Ended!";
                }
            } catch (e) { console.error(e); }
        }

        function updateUI() {
            const el = document.getElementById('plan-status');
            if (isPremium) {
                el.innerText = "üíé PREMIUM MEMBER";
                document.getElementById('lock-e').style.display = 'none';
                document.getElementById('lock-s').style.display = 'none';
                document.getElementById('pred-e').classList.remove('blur-sm');
                document.getElementById('pred-s').classList.remove('blur-sm');
                document.getElementById('premium-btn-box').style.display = 'none';
            } else {
                el.innerText = `‚è≥ TRIAL: ${remMins} MIN LEFT`;
            }
        }

        function startTimer() {
            if (timerStarted || isPremium) return;
            timerStarted = true;
            setInterval(async () => {
                if (remMins > 0) {
                    remMins--; syncBuffer++;
                    updateUI();
                    if (syncBuffer >= 3) {
                        await supabaseClient.rpc('sync_minutes', { input_device_id: deviceId, add_mins: syncBuffer });
                        syncBuffer = 0;
                    }
                    if (remMins <= 0) location.reload();
                }
            }, 60000);
        }

        function submit() {
            if (!isPremium && !timerStarted) startTimer();
            const input = document.getElementById('digit-input');
            const val = parseInt(input.value);
            const grp = val >= 5 ? 'B' : 'S';
            const entry = { val, grp, roll, stage, p: pNext, pOk: pNext ? pNext === grp : null, e: eNext, eOk: eNext ? eNext === grp : null, s: sNext, sOk: sNext ? sNext === grp : null };
            history.push(entry);
            if(stage === 10) { roll++; stage = 1; } else { stage++; }
            updatePred(val); renderTable(); save();
            input.value = ''; input.focus(); document.getElementById('btn-submit').disabled = true;
        }

        function updatePred(last) {
            pNext = last % 2 === 0 ? 'S' : 'B';
            if(history.length >= 3) eNext = history.slice(-3).reduce((a,b) => a+b.val, 0) % 2 === 0 ? 'S' : 'B';
            if(history.length >= 10) {
                let s10 = history.slice(-10).reduce((a,b) => a+b.val, 0);
                let dSum = s10; while (dSum >= 10) dSum = dSum.toString().split('').map(Number).reduce((a, b) => a + b, 0);
                sNext = (dSum % 2 !== 0) ? 'B' : 'S';
            } else sNext = null;
            document.getElementById('pred-p').innerText = pNext || '-';
            document.getElementById('pred-e').innerText = isPremium ? (eNext || '-') : "?";
            document.getElementById('pred-s').innerHTML = isPremium ? (sNext ? `<span>${sNext}</span>` : '-') : "?";
            document.getElementById('highlight-g').innerText = last;
        }

        function renderTable() {
            const container = document.getElementById('history-container'); container.innerHTML = '';
            const rolls = history.reduce((acc, cur) => { if(!acc[cur.roll]) acc[cur.roll] = []; acc[cur.roll].push(cur); return acc; }, {});
            Object.keys(rolls).forEach(r => {
                const b = document.createElement('div'); b.className = 'roll-card';
                b.innerHTML = `<div class="text-[10px] text-center font-bold text-cyan-500 mb-2 uppercase tracking-widest border-b border-white/10 pb-1">Roll ${r}</div>`;
                rolls[r].forEach(i => {
                    const eShow = isPremium ? i.e : "üîí";
                    const sShow = isPremium ? (i.s || "-") : "üîí";
                    const okS = isPremium ? (i.sOk === null ? '-' : (i.sOk ? '‚úÖ' : '‚ùå')) : "-";
                    b.innerHTML += `<div class="flex items-center justify-between py-1 border-b border-white/5 last:border-0">
                        <span class="text-[8px] text-gray-600 w-4">${i.stage}</span>
                        <div class="mini-shape border-[#ff4136] text-[#ff4136] rounded-full">${i.p||'-'}</div>
                        <span class="text-[10px] w-6 text-center">${i.pOk===null?'-':(i.pOk?'‚úÖ':'‚ùå')}</span>
                        <div class="mini-shape border-[#b10dc9] text-[#b10dc9] rounded-md">${eShow}</div>
                        <span class="text-[10px] w-6 text-center">${isPremium?(i.eOk?'‚úÖ':'‚ùå'):'-'}</span>
                        <div class="mini-shape border-[#2ecc40] text-[#2ecc40] rotate-45"><span class="-rotate-45">${sShow}</span></div>
                        <span class="text-[10px] w-6 text-center">${okS}</span>
                        <div class="g-num">${i.val}</div>
                    </div>`;
                });
                container.appendChild(b);
            });
            container.scrollLeft = container.scrollWidth;
        }

        function validate(el) { if(el.value.length > 1) el.value = el.value.slice(-1); document.getElementById('btn-submit').disabled = el.value === ""; }
        function save() { localStorage.setItem('OMNI_STORE', JSON.stringify({ history, roll, stage })); }
        function load() {
            const data = JSON.parse(localStorage.getItem('OMNI_STORE'));
            if(data) { history = data.history || []; roll = data.roll || 1; stage = data.stage || 1; renderTable(); if(history.length) updatePred(history[history.length-1].val); }
        }
        function fullReset() { if(confirm("Clear all logs?")) { localStorage.removeItem('OMNI_STORE'); location.reload(); } }
        function showUpgrade() { document.getElementById('app-main').style.display = 'none'; document.getElementById('lock-screen').style.display = 'flex'; }
        async function activateCode() {
            const code = document.getElementById('lock-license-input').value.trim();
            const { data } = await supabaseClient.rpc('activate_v2', { input_device_id: deviceId, input_code: code });
            if (data?.success) { alert("Premium Activated!"); location.reload(); } else alert("Invalid Key!");
        }

        load(); initDevice();
    </script>
</body>
</html>
