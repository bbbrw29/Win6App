<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Win 6 Pro - Dark Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap');
        body { font-family: 'Pyidaungsu', sans-serif; background-color: #000d1a; color: white; overflow-x: hidden; }
        
        /* Prediction Shapes (LOCKED) */
        .box-p { border: 4px solid #ff4136; color: #ff4136; border-radius: 50%; width: 65px; height: 65px; font-size: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; background: white; font-weight: 900; }
        .box-e { border: 4px solid #b10dc9; color: #b10dc9; border-radius: 12px; width: 65px; height: 65px; font-size: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; background: white; font-weight: 900; }
        .box-s { border: 4px solid #2ecc40; color: #2ecc40; border-radius: 8px; width: 60px; height: 60px; font-size: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; transform: rotate(45deg); background: white; font-weight: 900; }
        .box-s span { transform: rotate(-45deg); }

        /* Roll History Cards */
        .roll-card { flex-shrink: 0; width: 270px; background: rgba(0, 51, 102, 0.4); border-radius: 20px; padding: 12px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); }
        .status-ok { color: #00ff88; font-size: 24px; font-weight: 900; }
        .status-no { color: #ff3366; font-size: 24px; font-weight: 900; }

        .mini-shape { width: 28px; height: 28px; display: inline-flex; align-items: center; justify-content: center; background: white; font-weight: 900; font-size: 14px; border-width: 2px; }
        .p-circle { border-radius: 50%; border-color: #ff4136; color: #ff4136; }
        .e-square { border-radius: 6px; border-color: #b10dc9; color: #b10dc9; }
        .s-diamond { transform: rotate(45deg); border-color: #2ecc40; color: #2ecc40; border-radius: 4px; }
        .s-diamond span { transform: rotate(-45deg); }

        .g-num { background: #ffdc00; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 2px solid #000; color: black; font-weight: 900; font-size: 18px; }
        .g-display { font-size: 75px; font-weight: 900; color: #ffdc00; text-shadow: 4px 4px 0px #000; }

        /* Lock Screen Overlay */
        #lock-screen { position: fixed; inset: 0; background: #000d1a; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px; text-align: center; }
    </style>
</head>
<body class="p-2 pb-10">

    <div id="lock-screen" style="display: none;">
        <h1 class="text-yellow-400 text-5xl font-black mb-2 uppercase italic tracking-tighter">Win 6 Pro</h1>
        <p class="text-cyan-400 text-[10px] mb-10 tracking-[0.4em] font-bold italic uppercase opacity-70">Premium Prediction System</p>
        
        <div class="bg-red-600/10 border border-red-500/50 p-6 rounded-[2.5rem] mb-8 w-full max-w-sm">
            <p id="lock-msg" class="text-red-500 text-lg font-black uppercase italic">Checking Access...</p>
        </div>

        <div class="w-full max-w-sm space-y-4">
            <input type="text" id="license-input" class="w-full p-5 rounded-2xl text-black text-center font-black border-4 border-yellow-400 text-xl outline-none" placeholder="ENTER LICENSE CODE">
            <button onclick="activateCode()" class="w-full bg-yellow-400 text-black py-5 rounded-2xl font-black text-xl active:scale-95 shadow-lg uppercase transition-transform">Activate Pro</button>
            <p class="text-gray-600 text-[10px] mt-6 font-mono uppercase tracking-widest" id="device-id-display"></p>
        </div>
    </div>

    <div id="app-main" style="display: none;">
        <div class="max-w-md mx-auto space-y-4">
            
            <div class="text-center pt-2">
                <span id="plan-status" class="bg-cyan-500/10 text-cyan-400 text-[10px] px-5 py-2 rounded-full border border-cyan-500/30 font-bold uppercase tracking-widest italic shadow-sm">
                    Connecting to Server...
                </span>
            </div>

            <div class="bg-[#001f3d] p-4 grid grid-cols-3 gap-1 text-center rounded-[30px] border-b-4 border-cyan-500 shadow-2xl">
                <div><p class="text-[10px] font-bold text-gray-400 mb-1 uppercase">P Logic</p><div class="box-p"><span id="pred-p">-</span></div></div>
                <div><p class="text-[10px] font-bold text-gray-400 mb-1 uppercase">E Logic</p><div class="box-e"><span id="pred-e">-</span></div></div>
                <div><p class="text-[10px] font-bold text-gray-400 mb-1 uppercase">S Double</p><div class="box-s"><span id="pred-s"></span></div></div>
            </div>

            <div class="bg-[#002b52] p-5 rounded-[2.5rem] flex items-center justify-between border border-white/10 shadow-inner">
                <div class="text-center flex-1"><div id="highlight-g" class="g-display">-</div></div>
                <div class="flex flex-col gap-2 w-36">
                    <input type="number" id="digit-input" class="w-full rounded-xl text-center text-4xl font-black p-2 outline-none border-4 border-yellow-400 text-black bg-white" placeholder="?" oninput="validate(this)">
                    <button id="btn-submit" class="w-full py-4 bg-yellow-400 text-black font-black rounded-xl text-xl shadow-lg active:scale-95 disabled:opacity-30" onclick="submit()" disabled>ENTER</button>
                </div>
            </div>

            <div id="alert-box" class="hidden">
                <div class="bg-red-600 border-4 border-white text-white p-4 rounded-2xl text-center animate-pulse shadow-2xl">
                    <span id="alert-msg" class="text-2xl font-black uppercase"></span>
                </div>
            </div>

            <div class="space-y-2">
                <div class="flex justify-between items-center px-2">
                    <h3 class="font-black text-cyan-400 text-lg italic uppercase tracking-tighter">Live Record Logs</h3>
                    <span id="total-stg" class="text-xs font-bold opacity-40">0 STG</span>
                </div>
                <div id="history-container" class="flex overflow-x-auto gap-3 pb-4 scroll-smooth"></div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="copy()" class="bg-blue-600 py-4 text-white font-black rounded-2xl text-md uppercase border-b-4 border-blue-950 active:translate-y-1 active:border-b-0 transition-all">üìã Copy Data</button>
                <button onclick="reset()" class="bg-red-500 py-4 text-white font-black rounded-2xl text-md uppercase border-b-4 border-red-950 active:translate-y-1 active:border-b-0 transition-all">üîÑ Reset App</button>
            </div>

            <div class="bg-slate-900/80 p-5 rounded-[2.5rem] border border-white/10">
                <h3 class="font-black text-yellow-400 mb-3 text-[10px] uppercase tracking-[0.2em] text-center border-b border-white/5 pb-2 italic opacity-70">Pattern History Analysis</h3>
                <div id="warning-history" class="space-y-3 max-h-60 overflow-y-auto pr-1">
                    <div id="no-history-msg" class="text-center py-6 opacity-20 text-xs italic uppercase tracking-widest">No Patterns Found</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = 'https://folxuczagcspjnypyopw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvbHh1Y3phZ2NzcGpueXB5b3B3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjQ4MTAsImV4cCI6MjA4MTkwMDgxMH0.gOwmroH4rGr1iGATXK1NoSfg7gNs87hXJ8E3w13s5xo';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- AUTH & TIMER LOGIC (NEW) ---
        let deviceId = localStorage.getItem('win6pro_id') || 'W6P-' + Math.random().toString(36).substring(2, 10).toUpperCase();
        localStorage.setItem('win6pro_id', deviceId);
        document.getElementById('device-id-display').innerText = "DEVICE ID: " + deviceId;

        let remMins = 0; let isPremium = false; let elapsedSinceLastSync = 0;

        async function checkAccess() {
            try {
                const { data, error } = await supabaseClient.rpc('check_access_v2', { input_device_id: deviceId });
                if (error || !data || !data.can_access) {
                    document.getElementById('lock-screen').style.display = 'flex';
                    document.getElementById('lock-msg').innerText = data ? data.msg : 'Daily Limit Reached';
                    document.getElementById('app-main').style.display = 'none';
                } else {
                    isPremium = data.is_premium; 
                    remMins = data.mins || 0;
                    document.getElementById('lock-screen').style.display = 'none';
                    document.getElementById('app-main').style.display = 'block';
                    updateStatusUI(data);
                    if (!isPremium) startLocalTimer();
                }
            } catch (e) { 
                document.getElementById('lock-msg').innerText = "Trial Expired / Access Denied";
                document.getElementById('lock-screen').style.display = 'flex';
            }
        }

        function updateStatusUI(data) {
            const el = document.getElementById('plan-status');
            if (isPremium) {
                el.innerText = "üíé Premium Member (Unlimited)";
                el.className = "bg-yellow-400/10 text-yellow-400 text-[10px] px-5 py-2 rounded-full border border-yellow-400/30 font-bold uppercase tracking-widest italic shadow-sm";
            } else {
                el.innerText = `‚è≥ Trial: ${data.days} Days Left | ‚è±Ô∏è ${remMins} Min Today`;
            }
        }

        function startLocalTimer() {
            setInterval(async () => {
                if (remMins > 0) {
                    remMins--; elapsedSinceLastSync++;
                    document.getElementById('plan-status').innerText = `‚è≥ Trial Active | ‚è±Ô∏è ${remMins} Min Remaining`;
                    
                    // Sync every 5 minutes to save API requests
                    if (elapsedSinceLastSync >= 5) {
                        await supabaseClient.rpc('sync_minutes', { input_device_id: deviceId, add_mins: elapsedSinceLastSync });
                        elapsedSinceLastSync = 0;
                    }
                } else {
                    location.reload(); // Lock when time runs out
                }
            }, 60000); // Every 1 minute
        }

        // Final sync before closing app
        window.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden' && elapsedSinceLastSync > 0 && !isPremium) {
                navigator.sendBeacon(`${SUPABASE_URL}/rest/v1/rpc/sync_minutes`, JSON.stringify({
                    input_device_id: deviceId,
                    add_mins: elapsedSinceLastSync
                }));
            }
        });

        async function activateCode() {
            const code = document.getElementById('license-input').value.trim();
            if (!code) return alert("Please enter code");
            const { data } = await supabaseClient.rpc('activate_v2', { input_device_id: deviceId, input_code: code });
            if (data?.success) {
                alert("Pro Version Activated Successfully!");
                location.reload();
            } else {
                alert("Invalid or Used Code!");
            }
        }

        // --- ORIGINAL PREDICTION LOGIC (LOCKED - DO NOT CHANGE) ---
        let history = []; let warnings = []; let roll = 1, stage = 1;
        let pNext, eNext, sNext; let activePattern = null;

        function submit() {
            const input = document.getElementById('digit-input');
            const val = parseInt(input.value); const grp = val >= 5 ? 'B' : 'S';
            const entry = { val, grp, roll, stage, p: pNext, pOk: pNext ? pNext === grp : null, e: eNext, eOk: eNext ? eNext === grp : null, s: sNext, sOk: sNext ? sNext === grp : null };
            history.push(entry); managePatternLogic();
            if(stage === 10) { roll++; stage = 1; } else { stage++; }
            updatePred(val); renderTable(); save();
            input.value = ''; input.focus(); document.getElementById('btn-submit').disabled = true;
        }

        function managePatternLogic() {
            const seq = history.map(h => h.grp).join(''); let current = null;
            if(seq.length >= 4) {
                let dp = 0; for(let i=seq.length-1; i>=3; i-=2) { if(seq[i]===seq[i-1] && seq[i-2]===seq[i-3] && seq[i]!==seq[i-2]) dp += 2; else break; }
                if(dp >= 4) { if(seq.length % 2 !== 0 && seq[seq.length-1] === seq[seq.length-2]) dp += 1; current = { type: '·Ä°·Äê·ÄΩ·Ä≤·Äú·Ä≠·ÄØ·ÄÄ·Ä∫ (BBSS)', count: dp, start: history.length - dp }; }
            }
            if(!current) {
                let last = seq.slice(-1), sCount = 0; for(let i=seq.length-1; i>=0; i--) { if(seq[i]===last) sCount++; else break; }
                if(sCount >= 5) current = { type: last==='B'?'·Ä°·ÄÄ·Äº·ÄÆ·Ä∏·Äê·Äî·Ä∫·Ä∏':'·Ä°·Äû·Ä±·Ä∏·Äê·Äî·Ä∫·Ä∏', count: sCount, start: history.length - sCount };
            }
            const box = document.getElementById('alert-box');
            if(current) { activePattern = current; document.getElementById('alert-msg').innerText = `‚ö†Ô∏è ${current.type} ${current.count} ·ÄÄ·Äº·Ä≠·Äô·Ä∫`; box.classList.remove('hidden'); }
            else { if(activePattern) { const s = history[activePattern.start], e = history[history.length - 2]; warnings.unshift({ text: `[${activePattern.type}] ${activePattern.count} ·ÄÄ·Äº·Ä≠·Äô·Ä∫ (R${s.roll}S${s.stage} ·Äô·Äæ R${e.roll}S${e.stage} ·Ä°·Äë·Ä≠)` }); renderWarnings(); activePattern = null; } box.classList.add('hidden'); }
        }

        function updatePred(last) {
            pNext = last % 2 === 0 ? 'S' : 'B';
            if(history.length >= 3) { eNext = history.slice(-3).reduce((a,b) => a+b.val, 0) % 2 === 0 ? 'S' : 'B'; }
            if(history.length >= 10) { 
                let s10 = history.slice(-10).reduce((a,b) => a+b.val, 0); 
                let dSum = s10; while (dSum >= 10) { dSum = dSum.toString().split('').map(Number).reduce((a, b) => a + b, 0); }
                sNext = (dSum % 2 !== 0) ? 'B' : 'S';
            } else { sNext = null; }
            document.getElementById('pred-p').innerText = pNext || '-';
            document.getElementById('pred-e').innerText = eNext || '-';
            document.getElementById('pred-s').innerHTML = sNext ? `<span>${sNext}</span>` : '-';
            document.getElementById('highlight-g').innerText = last;
        }

        function renderTable() {
            const container = document.getElementById('history-container'); container.innerHTML = '';
            document.getElementById('total-stg').innerText = `${history.length} STG`;
            const rolls = history.reduce((acc, cur) => { if(!acc[cur.roll]) acc[cur.roll] = []; acc[cur.roll].push(cur); return acc; }, {});
            Object.keys(rolls).forEach(r => {
                const b = document.createElement('div'); b.className = 'roll-card';
                b.innerHTML = `<div class="text-md text-center font-black text-cyan-400 mb-2 border-b border-white/10 pb-1">ROLL ${r}</div>
                    <div class="grid grid-cols-8 gap-0 text-[9px] text-gray-500 font-bold mb-1 text-center italic uppercase"><span>STG</span><span>P</span><span>OK</span><span>E</span><span>OK</span><span>S</span><span>OK</span><span>G</span></div>`;
                rolls[r].forEach(i => {
                    b.innerHTML += `<div class="flex items-center justify-between py-1 border-b border-white/5 last:border-0">
                        <span class="text-[10px] font-bold text-gray-500 w-4">${i.stage}</span>
                        <div class="mini-shape p-circle">${i.p||'-'}</div>
                        <span class="${i.pOk?'status-ok':'status-no'} w-6 text-center">${i.pOk===null?'-':(i.pOk?'‚úÖ':'‚ùå')}</span>
                        <div class="mini-shape e-square">${i.e||'-'}</div>
                        <span class="${i.eOk?'status-ok':'status-no'} w-6 text-center">${i.eOk===null?'-':(i.eOk?'‚úÖ':'‚ùå')}</span>
                        <div class="mini-shape s-diamond"><span>${i.s||'-'}</span></div>
                        <span class="${i.sOk?'status-ok':'status-no'} w-6 text-center">${i.sOk===null?'-':(i.sOk?'‚úÖ':'‚ùå')}</span>
                        <div class="g-num">${i.val}</div>
                    </div>`;
                });
                container.appendChild(b);
            });
            container.scrollLeft = container.scrollWidth;
        }

        function renderWarnings() {
            const container = document.getElementById('warning-history');
            if(document.getElementById('no-history-msg')) document.getElementById('no-history-msg').remove();
            container.innerHTML = warnings.map((w, idx) => `<div class="p-3 bg-white/5 rounded-xl border-l-4 border-yellow-400 text-xs font-bold leading-relaxed shadow-sm">${warnings.length - idx}. ${w.text}</div>`).join('');
        }

        async function copy() {
            let t = "WIN6 PRO RECORD LOGS\n";
            history.forEach(i => { t += `R${i.roll}S${i.stage}: [${i.val}] P:${i.pOk?'‚úÖ':'‚ùå'} E:${i.eOk?'‚úÖ':'‚ùå'} S:${i.sOk?'‚úÖ':'‚ùå'}\n`; });
            await navigator.clipboard.writeText(t); alert("History Copied to Clipboard!");
        }

        function validate(el) { if(el.value.length > 1) el.value = el.value.slice(-1); document.getElementById('btn-submit').disabled = el.value === ""; }
        function save() { localStorage.setItem('WIN6_FINAL_STORE', JSON.stringify({ history, warnings, roll, stage, activePattern })); }
        function load() {
            const data = JSON.parse(localStorage.getItem('WIN6_FINAL_STORE'));
            if(data) { history = data.history; warnings = data.warnings || []; roll = data.roll; stage = data.stage; activePattern = data.activePattern || null; renderTable(); renderWarnings(); if(history.length) updatePred(history[history.length-1].val); }
        }
        function reset() { if(confirm("Are you sure you want to clear all data?")) { localStorage.clear(); location.reload(); } }

        // Start App
        load();
        checkAccess();
    </script>
</body>
</html>
