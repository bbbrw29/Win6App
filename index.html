<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni Logic Elite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pyidaungsu:wght@400;700&display=swap');
        body { font-family: 'Pyidaungsu', sans-serif; background-color: #010816; color: white; overflow-x: hidden; }
        .box-p { border: 4px solid #ff4136; color: #ff4136; border-radius: 50%; width: 65px; height: 65px; font-size: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; background: white; font-weight: 900; }
        .box-e { border: 4px solid #b10dc9; color: #b10dc9; border-radius: 12px; width: 65px; height: 65px; font-size: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; background: white; font-weight: 900; position: relative; }
        .box-s { border: 4px solid #2ecc40; color: #2ecc40; border-radius: 8px; width: 60px; height: 60px; font-size: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; transform: rotate(45deg); background: white; font-weight: 900; position: relative; }
        .box-s span { transform: rotate(-45deg); }
        .locked-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.85); border-radius: inherit; display: flex; align-items: center; justify-content: center; color: #fbbf24; font-size: 9px; font-weight: 900; border: 1px solid rgba(251,191,36,0.3); }
        .roll-card { flex-shrink: 0; width: 290px; background: rgba(30, 41, 59, 0.4); border-radius: 20px; padding: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .g-num { background: #ffdc00; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; border: 2px solid #000; color: black; font-weight: 900; }
        .mini-shape { width: 26px; height: 26px; display: inline-flex; align-items: center; justify-content: center; background: white; font-weight: 900; font-size: 12px; border-width: 2px; }
        .status-pulse { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .pattern-box { background: linear-gradient(90deg, #1e293b, #0f172a); border-left: 4px solid #fbbf24; }

        /* --- NEW STYLES: PATTERN INTELLIGENCE LOG --- */
        #intel-log-container { height: 220px; overflow-y: auto; background: rgba(15, 23, 42, 0.4); border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); padding: 12px; scroll-behavior: smooth; }
        .intel-entry { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 8px 0; display: flex; justify-content: space-between; align-items: center; }
        .intel-entry:last-child { border: none; }
        .intel-label { font-size: 11px; font-weight: 900; letter-spacing: 0.05em; }
        .intel-range { font-size: 10px; font-family: monospace; color: #64748b; }
        .intel-locked { position: absolute; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); border-radius: 20px; display: flex; align-items: center; justify-content: center; z-index: 10; cursor: pointer; }
    </style>
</head>
<body class="p-2 pb-10">

    <div id="lock-screen" class="fixed inset-0 bg-[#010816] z-[9999] flex flex-col items-center justify-center p-6 text-center" style="display: none;">
        <h1 class="text-4xl font-black mb-2 text-cyan-400 italic">OMNI LOGIC</h1>
        <p class="text-[10px] tracking-[0.3em] text-gray-500 mb-8 uppercase text-white">Elite Membership Required</p>

        <div class="bg-cyan-900/20 p-6 rounded-[2.5rem] border border-cyan-500/30 text-left mb-6 w-full max-w-sm shadow-2xl">
            <h4 class="text-yellow-400 font-black mb-3 italic">üíé ELITE BENEFITS:</h4>
            <ul class="text-xs space-y-3 text-gray-300">
                <li>‚úÖ Unlock <span class="text-purple-400 font-bold">E</span> & <span class="text-green-400 font-bold">S</span> Prediction Logics</li>
                <li>‚úÖ Deep Pattern Intelligence (Roll & Stage)</li>
                <li>‚úÖ Unlimited Access (No Daily Limit)</li>
                <li>‚úÖ Copy & Export History Logs</li>
            </ul>
            <div class="mt-5 pt-4 border-t border-white/5 text-center">
                <p class="text-3xl font-black text-white">5,000 MMK <span class="text-xs text-gray-500 font-normal">/ Monthly</span></p>
            </div>
        </div>

        <input type="text" id="lock-license-input" class="w-full max-w-sm p-4 rounded-2xl text-black text-center font-black border-4 border-cyan-500 mb-4 text-xl" placeholder="ENTER LICENSE CODE">
        <button onclick="activateCode()" class="w-full max-w-sm bg-cyan-500 py-4 rounded-2xl font-black text-xl shadow-lg active:scale-95 uppercase">Unlock Premium</button>
        <a href="YOUR_TELEGRAM_LINK" target="_blank" class="mt-6 text-cyan-400 font-bold underline italic text-sm">Contact Admin to Buy Key</a>
        <p class="text-gray-800 text-[10px] mt-10 font-mono" id="device-id-display"></p>
        <button onclick="hideUpgrade()" id="back-btn" class="mt-4 text-gray-500 text-xs uppercase font-bold" style="display:none;">‚Üê Back</button>
    </div>

    <div id="app-main" style="display: none;">
        <div class="max-w-md mx-auto space-y-4">
            
            <div class="text-center pt-4">
                <h1 class="text-3xl font-black italic text-cyan-500 mb-2">OMNI LOGIC</h1>
                <div class="flex flex-col items-center gap-1">
                    <div class="flex items-center gap-2 bg-white/5 px-4 py-1 rounded-full border border-white/10">
                        <span id="status-dot" class="w-2 h-2 rounded-full bg-green-500"></span>
                        <span id="plan-status" class="text-[10px] font-black tracking-widest text-cyan-400 uppercase italic">Syncing Access...</span>
                    </div>
                    <div id="day-counter" class="text-[9px] text-gray-500 font-bold uppercase tracking-tighter">Please wait...</div>
                </div>
            </div>

            <div class="bg-[#001d3d] p-4 grid grid-cols-3 gap-1 text-center rounded-[30px] border-b-4 border-cyan-500 shadow-2xl">
                <div>
                    <p class="text-[9px] font-bold text-gray-500 mb-1 uppercase">P-Logic (Free)</p>
                    <div class="box-p"><span id="pred-p">-</span></div>
                </div>
                <div>
                    <p class="text-[9px] font-bold text-gray-500 mb-1 uppercase">E-Logic</p>
                    <div class="box-e">
                        <span id="pred-e" class="blur-sm">-</span>
                        <div id="lock-e" class="locked-overlay" onclick="showUpgrade(true)">PREMIUM</div>
                    </div>
                </div>
                <div>
                    <p class="text-[9px] font-bold text-gray-500 mb-1 uppercase">S-Logic</p>
                    <div class="box-s">
                        <span id="pred-s" class="blur-sm"></span>
                        <div id="lock-s" class="locked-overlay" onclick="showUpgrade(true)"><span>PREMIUM</span></div>
                    </div>
                </div>
            </div>

            <div class="bg-[#001d3d] p-5 rounded-[2.5rem] flex items-center justify-between border border-white/5">
                <div class="text-center flex-1"><div id="highlight-g" class="text-6xl font-black text-cyan-400">-</div></div>
                <div class="flex flex-col gap-2 w-32">
                    <input type="number" id="digit-input" class="w-full rounded-xl text-center text-4xl font-black p-2 border-4 border-cyan-500 text-black" placeholder="?" oninput="validate(this)">
                    <button id="btn-submit" class="w-full py-4 bg-cyan-500 text-white font-black rounded-xl text-xl disabled:opacity-30" onclick="submit()" disabled>ENTER</button>
                </div>
            </div>

            <div id="pattern-section" class="px-2" style="display: none;">
                <div class="pattern-box p-3 rounded-xl border border-white/5">
                    <p class="text-[10px] text-yellow-500 font-black uppercase italic mb-1">Elite Trend Feed</p>
                    <div id="pattern-display" class="text-xl font-black tracking-[0.3em] text-white">NO DATA</div>
                </div>
            </div>

            <div class="flex items-center justify-between px-2 pt-2">
                <h3 class="font-black text-cyan-500 text-xs italic uppercase">Record Logs</h3>
                <button onclick="copyLogs()" class="text-[10px] bg-white/5 px-3 py-1 rounded-full border border-white/10 font-black uppercase text-gray-400">üìã Copy History</button>
            </div>
            <div id="history-container" class="flex overflow-x-auto gap-3 pb-2"></div>

            <div class="px-2">
                <h3 class="font-black text-yellow-500 text-[10px] italic uppercase mb-2 tracking-widest">Pattern Intelligence Log</h3>
                <div id="intel-wrapper" class="relative">
                    <div id="intel-log-container">
                        <div id="no-intel" class="text-center text-gray-600 text-[10px] mt-20 italic">Discovery in progress...</div>
                    </div>
                    <div id="intel-lock" class="intel-locked" onclick="showUpgrade(true)">
                        <div class="bg-yellow-500 text-black px-4 py-1.5 rounded-full font-black text-[10px] uppercase shadow-lg">üîí Unlock Intelligence History</div>
                    </div>
                </div>
            </div>

            <button onclick="fullReset()" class="w-full bg-slate-900/50 py-3 text-red-500 font-bold rounded-xl text-[9px] uppercase border border-red-900/10">Reset App Data</button>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://folxuczagcspjnypyopw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZvbHh1Y3phZ2NzcGpueXB5b3B3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzMjQ4MTAsImV4cCI6MjA4MTkwMDgxMH0.gOwmroH4rGr1iGATXK1NoSfg7gNs87hXJ8E3w13s5xo';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let deviceId = ""; let isPremium = false; let remMins = 0; let syncBuffer = 0;
        let history = []; let roll = 1, stage = 1; let pNext, eNext, sNext; let timerStarted = false;
        
        // --- PATTERN INTEL TRACKING ---
        let intelLogs = [];
        let currentStreak = { type: null, startRoll: 1, startStage: 1, count: 0 };

        async function getStableId() {
            let id = localStorage.getItem('omni_stable_id');
            if (!id) {
                const randomBits = Math.random().toString(36).substring(2, 10).toUpperCase();
                id = "OMNI-" + randomBits;
                localStorage.setItem('omni_stable_id', id);
            }
            return id;
        }

        async function init() {
            deviceId = await getStableId();
            document.getElementById('device-id-display').innerText = "DEVICE ID: " + deviceId;
            checkAccess();
        }

        async function checkAccess() {
            const { data } = await supabaseClient.rpc('check_access_v2', { input_device_id: deviceId });
            if (data && data.can_access) {
                isPremium = data.is_premium;
                remMins = isPremium ? data.mins : Math.min(data.mins, 90);
                
                if (!isPremium && remMins <= 0) {
                    showUpgrade(false);
                    return;
                }
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('app-main').style.display = 'block';
                updateUI(data);
                renderIntelLog(); // Render logs on load
            } else { showUpgrade(false); }
        }

        function updateUI(data) {
            const statusLabel = document.getElementById('plan-status');
            const dayLabel = document.getElementById('day-counter');
            const dot = document.getElementById('status-dot');

            if (isPremium) {
                statusLabel.innerText = "Elite Membership : Active";
                dayLabel.innerText = "Unlimited Daily Access";
                dot.className = "w-2 h-2 rounded-full bg-cyan-400 shadow-[0_0_8px_#22d3ee]";
                document.getElementById('lock-e').style.display = 'none';
                document.getElementById('lock-s').style.display = 'none';
                document.getElementById('pred-e').classList.remove('blur-sm');
                document.getElementById('pred-s').classList.remove('blur-sm');
                document.getElementById('pattern-section').style.display = 'block';
                document.getElementById('intel-lock').style.display = 'none'; // Unlock Intel Section
            } else {
                const days = data ? (data.days_left || 7) : 7;
                dayLabel.innerText = `Trial Expires in ${days} days`;
                if (remMins <= 5) {
                    statusLabel.innerHTML = `<span class="text-yellow-500">‚ö†Ô∏è ENDING SOON (${remMins}m)</span>`;
                    dot.className = "w-2 h-2 rounded-full bg-yellow-500 status-pulse";
                } else {
                    statusLabel.innerText = `Guest Access : ${remMins} Mins Left`;
                    dot.className = "w-2 h-2 rounded-full bg-green-500";
                }
            }
        }

        function startTimer() {
            if (timerStarted || isPremium) return;
            timerStarted = true;
            setInterval(async () => {
                if (remMins > 0) {
                    remMins--; syncBuffer++;
                    updateUI();
                    if (syncBuffer >= 3) {
                        await supabaseClient.rpc('sync_minutes', { input_device_id: deviceId, add_mins: syncBuffer });
                        syncBuffer = 0;
                    }
                    if (remMins <= 0) location.reload();
                } else { location.reload(); }
            }, 60000);
        }

        async function submit() {
            if (!isPremium && remMins <= 0) { location.reload(); return; }
            if (!isPremium && !timerStarted) startTimer();
            
            const input = document.getElementById('digit-input');
            const val = parseInt(input.value);
            const grp = val >= 5 ? 'B' : 'S';
            
            const entry = { val, grp, roll, stage, p: pNext, pOk: pNext ? pNext === grp : null, e: eNext, eOk: eNext ? eNext === grp : null, s: sNext, sOk: sNext ? sNext === grp : null };
            history.push(entry);
            
            // --- PATTERN TRACKING LOGIC ---
            processPatternIntel(grp, roll, stage);

            if(stage === 10) { roll++; stage = 1; } else { stage++; }
            
            updatePred(val); renderTable(); renderPattern(); save();
            input.value = ''; input.focus(); document.getElementById('btn-submit').disabled = true;
        }

        function processPatternIntel(grp, r, s) {
            if (currentStreak.type === null) {
                currentStreak = { type: grp, startRoll: r, startStage: s, count: 1 };
            } else if (currentStreak.type === grp) {
                currentStreak.count++;
            } else {
                // Streak Broken - Save if count >= 4
                if (currentStreak.count >= 4) {
                    intelLogs.push({
                        label: currentStreak.type === 'B' ? 'BIG STREAK' : 'SMALL STREAK',
                        color: currentStreak.type === 'B' ? 'text-red-500' : 'text-blue-500',
                        count: currentStreak.count,
                        start: `R${currentStreak.startRoll}S${currentStreak.startStage}`,
                        end: `R${r}S${s}`
                    });
                    renderIntelLog();
                }
                currentStreak = { type: grp, startRoll: r, startStage: s, count: 1 };
            }
        }

        function renderIntelLog() {
            const container = document.getElementById('intel-log-container');
            if (intelLogs.length === 0) return;
            document.getElementById('no-intel').style.display = 'none';
            container.innerHTML = '';
            
            [...intelLogs].reverse().forEach((log, index) => {
                const num = intelLogs.length - index;
                container.innerHTML += `
                    <div class="intel-entry">
                        <div>
                            <span class="text-gray-700 mr-2 text-[10px]">${num < 10 ? '0'+num : num}.</span>
                            <span class="${log.color} intel-label">${log.label} (${log.count})</span>
                        </div>
                        <div class="intel-range">${log.start} ‚Üí ${log.end}</div>
                    </div>
                `;
            });
        }

        function updatePred(last) {
            pNext = last % 2 === 0 ? 'S' : 'B';
            if(history.length >= 3) eNext = history.slice(-3).reduce((a,b) => a+b.val, 0) % 2 === 0 ? 'S' : 'B';
            if(history.length >= 10) {
                let s10 = history.slice(-10).reduce((a,b) => a+b.val, 0);
                let dSum = s10; while (dSum >= 10) dSum = dSum.toString().split('').map(Number).reduce((a, b) => a + b, 0);
                sNext = (dSum % 2 !== 0) ? 'B' : 'S';
            } else sNext = null;
            
            document.getElementById('pred-p').innerText = pNext || '-';
            document.getElementById('pred-e').innerText = isPremium ? (eNext || '-') : "?";
            document.getElementById('pred-s').innerHTML = isPremium ? (sNext ? `<span>${sNext}</span>` : '-') : "?";
            document.getElementById('highlight-g').innerText = last;
        }

        function renderPattern() {
            if (!isPremium || history.length < 5) return;
            const last5 = history.slice(-5).map(i => i.grp).join(' ');
            document.getElementById('pattern-display').innerText = last5;
        }

        function renderTable() {
            const container = document.getElementById('history-container'); container.innerHTML = '';
            const rolls = history.reduce((acc, cur) => { if(!acc[cur.roll]) acc[cur.roll] = []; acc[cur.roll].push(cur); return acc; }, {});
            Object.keys(rolls).forEach(r => {
                const b = document.createElement('div'); b.className = 'roll-card';
                b.innerHTML = `<div class="text-[9px] text-center font-bold text-cyan-500 mb-2 border-b border-white/5 pb-1 uppercase tracking-widest">Roll ${r}</div>`;
                rolls[r].forEach(i => {
                    const eShow = isPremium ? i.e : "üîí";
                    const sShow = isPremium ? (i.s || "-") : "üîí";
                    b.innerHTML += `<div class="flex items-center justify-between py-1 border-b border-white/5 last:border-0">
                        <span class="text-[8px] text-gray-600 w-3">${i.stage}</span>
                        <div class="mini-shape border-[#ff4136] text-[#ff4136] rounded-full">${i.p||'-'}</div>
                        <span class="text-[10px] w-5 text-center">${i.pOk===null?'-':(i.pOk?'‚úÖ':'‚ùå')}</span>
                        <div class="mini-shape border-[#b10dc9] text-[#b10dc9] rounded-md">${eShow}</div>
                        <span class="text-[10px] w-5 text-center">${isPremium?(i.eOk?'‚úÖ':'‚ùå'):'-'}</span>
                        <div class="mini-shape border-[#2ecc40] text-[#2ecc40] rotate-45"><span class="-rotate-45">${sShow}</span></div>
                        <span class="text-[10px] w-5 text-center">${isPremium?(i.sOk?'‚úÖ':'‚ùå'):'-'}</span>
                        <div class="g-num">${i.val}</div>
                    </div>`;
                });
                container.appendChild(b);
            });
            container.scrollLeft = container.scrollWidth;
        }

        function copyLogs() {
            if (!isPremium) { showUpgrade(true); return; }
            let t = "OMNI ELITE LOGS\n";
            history.forEach(i => { t += `R${i.roll}S${i.stage}: [${i.val}] P:${i.pOk?'‚úÖ':'‚ùå'} E:${i.eOk?'‚úÖ':'‚ùå'} S:${i.sOk?'‚úÖ':'‚ùå'}\n`; });
            navigator.clipboard.writeText(t); alert("Logs Copied!");
        }

        function validate(el) { if(el.value.length > 1) el.value = el.value.slice(-1); document.getElementById('btn-submit').disabled = el.value === ""; }
        function save() { localStorage.setItem('OMNI_STORE', JSON.stringify({ history, roll, stage, intelLogs })); }
        function load() {
            const data = JSON.parse(localStorage.getItem('OMNI_STORE'));
            if(data) { 
                history = data.history || []; 
                roll = data.roll || 1; 
                stage = data.stage || 1; 
                intelLogs = data.intelLogs || [];
                renderTable(); renderPattern(); renderIntelLog();
                if(history.length) updatePred(history[history.length-1].val); 
            }
        }
        function fullReset() { if(confirm("Clear App Cache?")) { localStorage.removeItem('OMNI_STORE'); location.reload(); } }
        function showUpgrade(backable) { 
            document.getElementById('app-main').style.display = 'none'; 
            document.getElementById('lock-screen').style.display = 'flex';
            document.getElementById('back-btn').style.display = backable ? 'block' : 'none';
        }
        function hideUpgrade() { document.getElementById('lock-screen').style.display = 'none'; document.getElementById('app-main').style.display = 'block'; }
        
        async function activateCode() {
            const code = document.getElementById('lock-license-input').value.trim();
            const { data } = await supabaseClient.rpc('activate_v2', { input_device_id: deviceId, input_code: code });
            if (data?.success) { alert("Premium Activated!"); location.reload(); } else alert("Invalid Key!");
        }

        load(); init();
    </script>
</body>
</html>
