

<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription App</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); width: 400px; text-align: center; }
        h2 { color: #007bff; }
        .status-box { padding: 15px; border-radius: 6px; margin-bottom: 20px; font-weight: bold; }
        #expired-status { background-color: #fdd; color: #d9534f; border: 1px solid #d9534f; }
        #active-status { background-color: #d4edda; color: #155724; border: 1px solid #155724; }
        #code-input { width: calc(100% - 22px); padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        #activate-btn { width: 100%; padding: 10px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        #activate-btn:hover { background-color: #1e7e34; }
        #message { margin-top: 15px; font-weight: bold; }
        #logout-btn { margin-top: 20px; padding: 8px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; }
    </style>
</head>
<body>

<div class="container">
    <h2>Subscription á€…á€®á€™á€¶á€á€”á€·á€ºá€á€½á€²á€™á€¾á€¯</h2>
    
    <div id="subscription-status" class="status-box">
        ... á€¡á€á€¼á€±á€¡á€”á€± á€…á€…á€ºá€†á€±á€¸á€”á€±á€á€Šá€º ...
    </div>

    <hr>
    
    <p>á€¡á€á€…á€º á€‘á€•á€ºá€™á€¶ á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º (á€á€…á€ºá€œ á€…á€¬)</p>
    <input type="text" id="code-input" placeholder="Subscription Code á€‘á€Šá€·á€ºá€•á€«" required>
    
    <input type="hidden" id="month-batch" value="Dec_2025"> 
    
    <button id="activate-btn">Activate á€œá€¯á€•á€ºá€™á€Šá€º</button>
    
    <p id="message"></p>
    
    <button id="logout-btn">á€¡á€€á€±á€¬á€„á€·á€ºá€‘á€½á€€á€ºá€›á€”á€º</button>
</div>

<script>
    // **********************************************
    // ğŸ”‘ SUPABASE CONFIGURATION (Key á€¡á€á€…á€ºá€™á€»á€¬á€¸)
    // **********************************************
    const SUPABASE_URL = 'https://qqyabwiknxdypxcdoxev.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxeWFid2lrbnhkeXB4Y2RveGV2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NjQ5MzIsImV4cCI6MjA4MTQ0MDkzMn0.HOXs3rh3Qs0JdgnI3O3hE6p4sBDRSGK_DrChgQiQUHE';

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    const statusDiv = document.getElementById('subscription-status');
    const messageDiv = document.getElementById('message');
    const codeInput = document.getElementById('code-input');
    const activateBtn = document.getElementById('activate-btn');
    const monthBatch = document.getElementById('month-batch').value;
    
    let currentUserId = null;

    // á€›á€€á€ºá€…á€½á€² Format á€•á€¼á€±á€¬á€„á€ºá€¸á€œá€²á€á€¼á€„á€ºá€¸
    function formatDate(dateString) {
        if (!dateString) return 'á€™á€›á€¾á€­á€á€±á€¸á€•á€«';
        const date = new Date(dateString);
        return date.toLocaleDateString('my-MM', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Subscription Status á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€á€¼á€„á€ºá€¸
    async function checkSubscriptionStatus(userId) {
        messageDiv.textContent = 'Subscription á€¡á€á€¼á€±á€¡á€”á€± á€…á€…á€ºá€†á€±á€¸á€”á€±á€•á€«á€á€Šá€º...';
        
        // 1. profiles table á€™á€¾ end_date á€€á€­á€¯ á€›á€šá€°á€á€¼á€„á€ºá€¸
        const { data: profile, error } = await supabase
            .from('profiles')
            .select('subscription_end_date')
            .eq('id', userId)
            .single();

        if (error && error.code !== 'PGRST116') { // PGRST116 á€†á€­á€¯á€á€Šá€ºá€™á€¾á€¬ Row á€™á€›á€¾á€­á€á€±á€¸á€•á€« (á€¡á€á€…á€ºá€–á€¼á€…á€ºá€”á€±á€•á€«á€á€Šá€º)
            messageDiv.textContent = `á€¡á€á€¼á€±á€¡á€”á€± á€…á€…á€ºá€†á€±á€¸á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸: ${error.message}`;
            statusDiv.innerHTML = `<span style="color:red;">Error</span>`;
            return;
        }

        let endDate = null;
        if (profile) {
            endDate = profile.subscription_end_date;
        } else {
             // 2. Row á€™á€›á€¾á€­á€á€±á€¸á€•á€«á€€ á€¡á€á€…á€º á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€á€¼á€„á€ºá€¸ (RLS á€™á€œá€¯á€•á€ºá€‘á€¬á€¸á€á€±á€¬á€€á€¼á€±á€¬á€„á€·á€º á€¤á€á€­á€¯á€· á€œá€¯á€•á€ºá€›á€•á€«á€á€Šá€º)
             // PRODUCTION á€á€½á€„á€º RLS á€€á€­á€¯ á€á€á€ºá€™á€¾á€á€ºá€›á€•á€«á€™á€Šá€ºá‹
            const { error: insertError } = await supabase
                .from('profiles')
                .insert([{ id: userId }])
                .select();
            
            if (insertError) {
                console.error("Profile á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€¬á€á€½á€„á€º á€¡á€™á€¾á€¬á€¸:", insertError);
            }
        }
        
        const today = new Date();
        const end = endDate ? new Date(endDate) : null;
        
        statusDiv.className = 'status-box';
        
        if (!end || end <= today) {
            // Expired á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º á€…á€™á€‘á€¬á€¸á€á€±á€¸
            statusDiv.id = 'expired-status';
            statusDiv.innerHTML = `
                á€¡á€á€¼á€±á€¡á€”á€±: **Expired** á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º **Inactive** <br>
                Subscription á€•á€¼á€®á€¸á€†á€¯á€¶á€¸á€›á€€á€º: **${formatDate(endDate)}**
            `;
            messageDiv.textContent = 'Code á€‘á€Šá€·á€ºá€á€½á€„á€ºá€¸á€›á€”á€º á€œá€­á€¯á€¡á€•á€ºá€•á€«á€á€Šá€ºá‹';
        } else {
            // Active á€–á€¼á€…á€ºá€”á€±
            statusDiv.id = 'active-status';
            statusDiv.innerHTML = `
                á€¡á€á€¼á€±á€¡á€”á€±: **Active** <br>
                Subscription á€•á€¼á€®á€¸á€†á€¯á€¶á€¸á€›á€€á€º: **${formatDate(endDate)}**
            `;
            messageDiv.textContent = 'á€á€„á€ºá Subscription á€á€€á€ºá€á€™á€ºá€¸ á€›á€¾á€­á€”á€±á€•á€«á€á€Šá€ºá‹';
        }
    }

    // Code Activate á€œá€¯á€•á€ºá€á€¼á€„á€ºá€¸
    activateBtn.addEventListener('click', async () => {
        const code = codeInput.value.trim();
        if (!code) {
            messageDiv.textContent = 'á€€á€»á€±á€¸á€‡á€°á€¸á€•á€¼á€¯á Code á€‘á€Šá€·á€ºá€•á€«á‹';
            return;
        }

        activateBtn.disabled = true;
        messageDiv.textContent = 'Code á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€”á€±á€•á€«á€á€Šá€º...';

        // Stored Function á€€á€­á€¯ á€á€±á€«á€ºá€á€¼á€„á€ºá€¸ (p_duration_days á€á€Šá€º default 30 á€›á€€á€ºá€šá€°á€•á€«á€á€Šá€º)
        const { data, error } = await supabase.rpc('activate_subscription', {
            p_code: code,
            p_user_id: currentUserId,
            p_month_batch: monthBatch 
        });

        if (error || data === false) {
            messageDiv.textContent = 'Code á€á€Šá€º á€™á€™á€¾á€”á€ºá€€á€”á€ºá€•á€«áŠ á€¡á€á€¯á€¶á€¸á€•á€¼á€¯á€•á€¼á€®á€¸á€á€¬á€¸ á€á€­á€¯á€·á€™á€Ÿá€¯á€á€º Batch á€™á€™á€¾á€”á€ºá€€á€”á€ºá€•á€«: ' + (error ? error.message : '');
        } else {
            messageDiv.textContent = 'Subscription á€¡á€±á€¬á€„á€ºá€™á€¼á€„á€ºá€…á€½á€¬ Activate á€œá€¯á€•á€ºá€•á€¼á€®á€¸á€•á€«á€•á€¼á€®! áƒá€ á€›á€€á€º á€á€­á€¯á€¸á€•á€±á€¸á€œá€­á€¯á€€á€ºá€•á€«á€•á€¼á€®á‹';
            codeInput.value = '';
            checkSubscriptionStatus(currentUserId); // Status á€•á€¼á€”á€ºá€…á€…á€ºá€†á€±á€¸á€á€¼á€„á€ºá€¸
        }
        activateBtn.disabled = false;
    });

    // á€¡á€€á€±á€¬á€„á€·á€ºá€‘á€½á€€á€ºá€á€¼á€„á€ºá€¸
    document.getElementById('logout-btn').addEventListener('click', async () => {
        const { error } = await supabase.auth.signOut();
        if (!error) {
            window.location.href = 'index.html';
        }
    });

    // á€…á€á€„á€ºá€á€»á€­á€”á€ºá€á€½á€„á€º User á€€á€­á€¯ á€…á€…á€ºá€†á€±á€¸á€•á€¼á€®á€¸ Status á€€á€­á€¯ á€á€„á€ºá€á€¼á€„á€ºá€¸
    async function initApp() {
        const { data: { user } } = await supabase.auth.getUser();

        if (!user) {
            // Login á€á€„á€ºá€™á€‘á€¬á€¸á€›á€„á€º index.html á€€á€­á€¯ á€•á€¼á€”á€ºá€á€½á€¬á€¸
            window.location.href = 'index.html';
            return;
        }

        currentUserId = user.id;
        checkSubscriptionStatus(currentUserId);
    }

    initApp();
</script>

</body>
</html>
