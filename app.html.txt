
<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game App</title>
    <link rel="stylesheet" href="app.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        .hidden { display: none !important; }
        #sub-area { text-align: center; padding: 40px 20px; background: #1e293b; border-radius: 15px; margin: 20px; }
        .status { padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; }
        .active { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
        .expired { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    </style>
</head>
<body style="background:#0f172a; color:white;">

<div id="sub-page">
    <div id="sub-area">
        <h2>သက်တမ်းစစ်ဆေးခြင်း</h2>
        <div id="status-box" class="status">စစ်ဆေးနေသည်...</div>
        <div id="input-box">
            <input type="text" id="code-input" placeholder="Code ထည့်ပါ" style="width:80%; padding:10px; margin-bottom:10px; border-radius:5px;">
            <button onclick="activate()" style="padding:10px 20px; background:#0284c7; color:white; border:none; border-radius:5px;">Activate</button>
        </div>
        <button id="play-btn" class="hidden" onclick="openGame()" style="background:#16a34a; padding:15px; width:100%; border-radius:10px; margin-top:20px; color:white; font-weight:bold;">ဂိမ်းကစားမည် ➔</button>
        <button onclick="logout()" style="margin-top:30px; background:none; border:none; color:gray; text-decoration:underline;">Logout</button>
    </div>
</div>

<div id="game-page" class="hidden" style="padding:15px;">
    <div class="game-card">
        <div id="datetime-display" style="font-size:10px; color:gray;"></div>
        <div id="round-display" style="color:#38bdf8; font-weight:bold; margin-bottom:10px;"></div>
        
        <div id="current-digit-display" class="hidden" style="text-align:center;">
             <div class="large-bubble neon-solid-s" id="current-digit">...</div>
        </div>

        <div style="display:flex; justify-content:space-around; margin:20px 0;">
            <div>Prediction: <div id="app-prediction" class="large-bubble neon-solid-b">...</div></div>
            <div>Extra: <div id="app-extra-prediction" class="large-bubble neon-border-s">...</div></div>
        </div>

        <div id="input-area" style="text-align:center;">
            <input type="number" id="next-digit-input" class="input-digit" placeholder="?" oninput="handleInput(event)" onkeyup="checkEnter(event)">
            <button onclick="submitDigit()" style="background:#ef4444; width:100%; padding:12px; border-radius:8px; color:white; font-weight:bold;">SUBMIT</button>
        </div>
    </div>
    <div id="history-log-container" style="margin-top:20px;"></div>
</div>

<script src="apl.js"></script>
<script>
    async function checkStatus() {
        const { data: { user } } = await client.auth.getUser();
        if (!user) { window.location.href = 'index.html'; return; }
        const { data } = await client.from('profiles').select('subscription_expiry').eq('id', user.id).single();
        const now = new Date();
        const expiry = data?.subscription_expiry ? new Date(data.subscription_expiry) : null;
        const box = document.getElementById('status-box');
        if (expiry && expiry > now) {
            box.className = 'status active';
            box.innerText = "Active ✅ - သက်တမ်းရှိသည်";
            document.getElementById('play-btn').classList.remove('hidden');
            document.getElementById('input-box').classList.add('hidden');
        } else {
            box.className = 'status expired';
            box.innerText = "Expired ❌ - သက်တမ်းကုန်ပြီ";
        }
    }
    async function activate() {
        const code = document.getElementById('code-input').value;
        const { data } = await client.rpc('activate_subscription', { input_code: code });
        if (data) { alert("အောင်မြင်ပါသည်"); checkStatus(); }
        else alert("Code မှားနေပါသည်။");
    }
    function openGame() {
        document.getElementById('sub-page').classList.add('hidden');
        document.getElementById('game-page').classList.remove('hidden');
        if (window.initGame) initGame();
    }
    async function logout() { await client.auth.signOut(); window.location.href = 'index.html'; }
    window.onload = checkStatus;
</script>
</body>
</html>
